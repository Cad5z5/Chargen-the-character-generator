<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Character Card V2 Generator • JSON + PNG (tEXt: "chara")</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --bg:#0f1220; --panel:#171a2b; --ink:#e7e9f3; --muted:#a7acc4; --accent:#6fe3ff; --accent2:#ffd166; --ok:#2dd4bf; --err:#ff6b6b; --border:#2a2f47; }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font:15px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Arial}
    header{position:sticky;top:0;z-index:10;background:#0d1020;border-bottom:1px solid var(--border);padding:12px 16px}
    h1{margin:0 0 6px 0;font-size:18px}
    main{max-width:1100px;margin:18px auto 60px;padding:0 16px}
    .row{display:grid;gap:12px}
    @media(min-width:860px){.grid-2{grid-template-columns:1fr 1fr}.grid-3{grid-template-columns:1fr 1fr 1fr}}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:10px;padding:14px;margin-bottom:14px}
    label{display:block;margin:8px 0 4px;font-weight:600}
    input[type="text"], textarea{width:100%;padding:10px;border-radius:8px;border:1px solid var(--border);background:#0f1326;color:var(--ink)}
    textarea{min-height:90px;resize:vertical}
    .controls{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px}
    button{border:none;border-radius:8px;padding:10px 14px;font-weight:700;cursor:pointer}
    .primary{background:var(--accent);color:#041019}
    .secondary{background:#2b3052;color:var(--ink)}
    .warn{background:var(--err);color:#1b0c0c}
    .badge{display:inline-block;background:#22334a;color:var(--ink);padding:2px 8px;border-radius:999px;font-size:12px;margin-left:6px}
    .status{margin-top:8px;font-size:13px}
    .ok{color:var(--ok)} .err{color:var(--err)} .muted{color:var(--muted)}
    .preview{display:flex;gap:12px;align-items:center}
    .preview img{max-height:120px;border-radius:8px;border:1px solid var(--border)}
    .hint{font-size:12px;color:var(--muted);margin-top:4px}
    .file-inline{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .chip{display:inline-block;padding:4px 8px;border-radius:999px;background:#22334a;color:var(--ink);font-size:12px}
  </style>
</head>
<body>
<header>
  <h1>Character Card V2 Generator <span class="badge">spec: "chara_card_v2"</span> <span class="badge">spec_version: "2.0"</span></h1>
  <div class="file-inline">
    <input type="file" id="importFile" accept=".json,application/json">
    <button id="btnImport" class="secondary">Import JSON</button>
    <input type="file" id="imageFile" accept="image/png,image/jpeg">
    <span class="chip">Portrait for PNG export (PNG/JPEG)</span>
  </div>
  <div id="hdrStatus" class="status muted"></div>
</header>

<main>
  <section class="card">
    <div class="row grid-2">
      <div>
        <label for="name">Name</label>
        <input id="name" type="text" placeholder="e.g., Chargen">
      </div>
      <div>
        <label for="creator">Creator</label>
        <input id="creator" type="text" placeholder="e.g., Jānis">
      </div>
    </div>

    <label for="description">Description</label>
    <textarea id="description" placeholder="One clear paragraph: role, purpose, value."></textarea>

    <div class="row grid-2">
      <div>
        <label for="scenario">Scenario</label>
        <textarea id="scenario" placeholder="Where and how the user engages this character."></textarea>
      </div>
      <div>
        <label for="first_mes">First message</label>
        <textarea id="first_mes" placeholder="Short, in-voice, actionable opening line."></textarea>
      </div>
    </div>

    <div class="row grid-2">
      <div>
        <label for="system_prompt">System prompt</label>
        <textarea id="system_prompt" placeholder="Behavioral rules, scope, tone, do/don't."></textarea>
      </div>
      <div>
        <label for="post_history_instructions">Post-history instructions</label>
        <textarea id="post_history_instructions" placeholder="Consistency rules after the chat begins."></textarea>
      </div>
    </div>

    <div class="row grid-2">
      <div>
        <label for="mes_example">Message example</label>
        <textarea id="mes_example" placeholder="User: ...&#10;Character: ..."></textarea>
        <div class="hint">Use new lines; JSON will include them as \n.</div>
      </div>
      <div>
        <label for="character_version">Character version</label>
        <input id="character_version" type="text" value="1.0">
      </div>
    </div>
  </section>

  <section class="card row grid-2">
    <div>
      <h3 style="margin:0 0 6px 0">Lists</h3>
      <label for="personality">Personality (one per line)</label>
      <textarea id="personality" placeholder="Empathetic&#10;Observant&#10;Creative"></textarea>

      <label for="alternate_greetings">Alternate greetings (one per line)</label>
      <textarea id="alternate_greetings" placeholder="Variant 1&#10;Variant 2&#10;Variant 3"></textarea>

      <label for="tags">Tags (one per line)</label>
      <textarea id="tags" placeholder="domain&#10;style&#10;use_case"></textarea>
    </div>
    <div>
      <h3 style="margin:0 0 6px 0">Portrait</h3>
      <div class="preview">
        <img id="imgPreview" alt="Portrait preview" src="" style="display:none">
        <div class="muted">Upload a PNG/JPEG above. It will be used as the PNG base.</div>
      </div>
      <div class="hint">If no image is selected, exporter will generate a simple canvas with the character name.</div>
    </div>
  </section>

  <section class="card">
    <h3 style="margin:0 0 6px 0">Validate & export</h3>
    <div class="row grid-3">
      <div>
        <label for="filename">File name</label>
        <input id="filename" type="text" placeholder="auto: <name>_card_v2.json">
      </div>
      <div class="controls" style="align-items:end">
        <button id="btnValidate" class="secondary">Validate</button>
        <button id="btnDownload" class="primary">Download JSON</button>
        <button id="btnPNG" class="secondary">Download PNG</button>
        <button id="btnReset" class="warn">Reset</button>
      </div>
    </div>
    <div id="status" class="status muted"></div>
    <div class="hint">Minimum required: name, description, scenario, first_mes, system_prompt, personality[≥1], tags[≥1], creator, character_version.</div>
  </section>
</main>

<script>
(function(){
  const $ = id => document.getElementById(id);
  const status = $('status'), hdrStatus = $('hdrStatus');

  // Preview portrait
  $('imageFile').addEventListener('change', () => {
    const f = $('imageFile').files[0];
    if (!f) { $('imgPreview').style.display='none'; $('imgPreview').src=''; return; }
    const r = new FileReader();
    r.onload = () => { $('imgPreview').src = r.result; $('imgPreview').style.display='block'; };
    r.readAsDataURL(f);
  });

  // Import trigger
  $('btnImport').addEventListener('click', () => $('importFile').click());

  // Import handler
  $('importFile').addEventListener('change', () => {
    const file = $('importFile').files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = () => {
      try {
        const obj = JSON.parse(reader.result);
        if (!obj || obj.spec !== 'chara_card_v2' || obj.spec_version !== '2.0' || !obj.data) {
          throw new Error('Not a Character Card V2 JSON.');
        }
        fillForm(obj.data);
        ok(hdrStatus, 'Imported ' + file.name);
      } catch(e) {
        err(hdrStatus, 'Import failed: ' + e.message);
      }
    };
    reader.readAsText(file, 'utf-8');
  });

  function fillForm(d){
    setVal('name', d.name);
    setVal('creator', d.creator);
    setVal('description', d.description);
    setVal('scenario', d.scenario);
    setVal('first_mes', d.first_mes);
    setVal('system_prompt', d.system_prompt);
    setVal('post_history_instructions', d.post_history_instructions);
    setVal('mes_example', d.mes_example);
    setLines('personality', arrify(d.personality));
    setLines('alternate_greetings', arrify(d.alternate_greetings));
    setLines('tags', arrify(d.tags));
    setVal('character_version', d.character_version || '1.0');
  }
  function setVal(id, v){ if ($(id) && typeof v === 'string') $(id).value = v; }
  function setLines(id, arr){ if ($(id)) $(id).value = (arr||[]).join('\n'); }
  function arrify(v){ return Array.isArray(v) ? v : (typeof v === 'string' && v.trim() ? [v.trim()] : []); }

  function linesToArray(txt){ return (txt||'').split(/\r?\n/).map(s=>s.replace(/\u00A0/g,' ').trim()).filter(Boolean); }
  function sanitizeFilename(name){ return (name||'character').toLowerCase().replace(/\s+/g,'_').replace(/[^a-z0-9_\-]/g,'') + '_card_v2.json'; }

  function buildCard(){
    return {
      spec: 'chara_card_v2',
      spec_version: '2.0',
      data: {
        name: $('name').value.trim(),
        description: $('description').value.trim(),
        personality: linesToArray($('personality').value),
        scenario: $('scenario').value.trim(),
        first_mes: $('first_mes').value.replace(/\r\n/g,'\n').trim(),
        alternate_greetings: linesToArray($('alternate_greetings').value),
        mes_example: $('mes_example').value.replace(/\r\n/g,'\n').trim(),
        system_prompt: $('system_prompt').value.replace(/\r\n/g,'\n').trim(),
        post_history_instructions: $('post_history_instructions').value.replace(/\r\n/g,'\n').trim(),
        tags: linesToArray($('tags').value),
        creator: $('creator').value.trim(),
        character_version: $('character_version').value.trim() || '1.0'
      }
    };
  }

  function validate(obj){
    const e = [];
    if (obj.spec !== 'chara_card_v2') e.push('spec must be "chara_card_v2".');
    if (obj.spec_version !== '2.0') e.push('spec_version must be "2.0".');
    const d = obj.data || {};
    if (!d.name) e.push('name is required.');
    if (!d.description) e.push('description is required.');
    if (!Array.isArray(d.personality) || d.personality.length < 1) e.push('personality needs at least 1 item.');
    if (!d.scenario) e.push('scenario is required.');
    if (!d.first_mes) e.push('first_mes is required.');
    if (!d.system_prompt) e.push('system_prompt is required.');
    if (!Array.isArray(d.tags) || d.tags.length < 1) e.push('tags need at least 1 item.');
    if (!d.creator) e.push('creator is required.');
    if (!d.character_version) e.push('character_version is required.');
    return e;
  }

  function err(el,msg){ el.textContent = msg; el.className = 'status err'; }
  function ok(el,msg){ el.textContent = msg; el.className = 'status ok'; }
  function note(el,msg){ el.textContent = msg; el.className = 'status muted'; }

  $('btnValidate').addEventListener('click', () => {
    try{
      const obj = buildCard();
      const errors = validate(obj);
      if (errors.length) err(status, 'Invalid: ' + errors.join(' | '));
      else ok(status, 'Valid Character Card V2.');
    }catch(e){ err(status, 'Validation error: ' + e.message); }
  });

  // JSON download
  $('btnDownload').addEventListener('click', () => {
    try{
      const obj = buildCard();
      const errors = validate(obj);
      if (errors.length){ err(status, 'Cannot download. Fix: ' + errors.join(' | ')); return; }
      const pretty = JSON.stringify(obj, null, 2);
      const fname = (($('filename').value.trim() || sanitizeFilename(obj.data.name)) || 'character_card_v2.json').replace(/\.png$/i,'').replace(/\.json$/i,'') + '.json';
      const blob = new Blob([pretty], {type:'application/json;charset=utf-8'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = fname;
      document.body.appendChild(a);
      a.click();
      setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 200);
      ok(status, 'JSON saved: ' + fname);
    }catch(e){ err(status, 'Download error: ' + e.message); }
  });

  // PNG export
  $('btnPNG').addEventListener('click', async () => {
    try{
      const obj = buildCard();
      const errors = validate(obj);
      if (errors.length){ err(status, 'Cannot export PNG. Fix: ' + errors.join(' | ')); return; }
      const jsonStr = JSON.stringify(obj);
      const basePngBlob = await renderBasePNG();
      const outBytes = await embedTextChunk(basePngBlob, 'chara', jsonStr);
      const fname = (($('filename').value.trim() || sanitizeFilename(obj.data.name)) || 'character_card_v2.json').replace(/\.json$/i,'').replace(/\.png$/i,'') + '.png';
      const a = document.createElement('a');
      a.href = URL.createObjectURL(new Blob([outBytes], {type:'image/png'}));
      a.download = fname;
      document.body.appendChild(a);
      a.click();
      setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 200);
      ok(status, 'PNG saved: ' + fname);
    }catch(e){ err(status, 'PNG export error: ' + e.message); }
  });

  // Render base PNG from uploaded portrait or fallback canvas
  function renderBasePNG(){
    return new Promise((resolve,reject)=>{
      const file = $('imageFile').files[0];
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');

      if (file){
        const r = new FileReader();
        r.onload = () => {
          const img = new Image();
          img.onload = () => {
            canvas.width = img.width; canvas.height = img.height;
            ctx.drawImage(img,0,0);
            canvas.toBlob(b => b ? resolve(b) : reject(new Error('Canvas toBlob failed')), 'image/png');
          };
          img.onerror = () => reject(new Error('Portrait image failed to load'));
          img.src = r.result;
        };
        r.onerror = () => reject(new Error('Portrait file reading failed'));
        r.readAsDataURL(file);
      } else {
        // Fallback: simple background with name
        canvas.width = 768; canvas.height = 1024;
        const g = ctx.createLinearGradient(0,0,0,canvas.height);
        g.addColorStop(0,'#141a2b'); g.addColorStop(1,'#0c1020');
        ctx.fillStyle = g; ctx.fillRect(0,0,canvas.width,canvas.height);
        ctx.fillStyle = '#6fe3ff'; ctx.font = 'bold 48px Segoe UI, sans-serif';
        ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
        ctx.fillText(($('name').value.trim() || 'Character'), canvas.width/2, canvas.height/2);
        canvas.toBlob(b => b ? resolve(b) : reject(new Error('Canvas toBlob failed')), 'image/png');
      }
    });
  }

  // PNG utilities
  function u32be(n){ const b=new Uint8Array(4); b[0]=(n>>>24)&255; b[1]=(n>>>16)&255; b[2]=(n>>>8)&255; b[3]=n&255; return b; }
  function crcTableBuild(){
    const table = new Uint32Array(256);
    for (let n=0;n<256;n++){
      let c = n;
      for (let k=0;k<8;k++){ c = (c & 1) ? (0xEDB88320 ^ (c >>> 1)) : (c >>> 1); }
      table[n] = c >>> 0;
    }
    return table;
  }
  const CRC_TABLE = crcTableBuild();
  function crc32(bytes){
    let c = 0xFFFFFFFF;
    for (let i=0;i<bytes.length;i++){
      c = CRC_TABLE[(c ^ bytes[i]) & 0xFF] ^ (c >>> 8);
    }
    return (c ^ 0xFFFFFFFF) >>> 0;
  }
  function concat(...arrays){
    let total = arrays.reduce((s,a)=>s+a.length,0);
    const out = new Uint8Array(total);
    let off=0;
    for (const a of arrays){ out.set(a,off); off += a.length; }
    return out;
  }

  // Build a tEXt chunk with keyword and text (BASE64 ENCODED)
  function makeTextChunk(keyword, text){
    const te = new TextEncoder();
    const key = (keyword || 'chara').slice(0,79).replace(/\0/g,'');
    const keyBytes = te.encode(key);
    const sep = new Uint8Array([0]); // null separator
    
    // CORRECTED PART: Base64 encode the JSON string to make it compatible.
    // The unescape(encodeURIComponent(text)) is a robust way to handle Unicode characters in btoa.
    const base64EncodedText = btoa(unescape(encodeURIComponent(text)));
    const txtBytes = te.encode(base64EncodedText);

    const type = te.encode('tEXt');
    const data = concat(keyBytes, sep, txtBytes);
    const len = u32be(data.length);
    const crc = u32be(crc32(concat(type, data)));
    return concat(len, type, data, crc);
  }

  // Insert tEXt chunk immediately after IHDR
  function embedTextChunk(pngBlob, keyword, text){
    return new Promise((resolve,reject)=>{
      const r = new FileReader();
      r.onload = () => {
        try{
          const bytes = new Uint8Array(r.result);
          // Verify signature
          const sig = bytes.subarray(0,8);
          const PNG_SIG = new Uint8Array([137,80,78,71,13,10,26,10]);
          for (let i=0;i<8;i++) if (sig[i] !== PNG_SIG[i]) throw new Error('Not a PNG');

          // Locate end of IHDR
          let off = 8;
          const ihdrLen = readU32(bytes, off); off += 4;
          const type = str(bytes.subarray(off, off+4)); off += 4;
          if (type !== 'IHDR') throw new Error('Missing IHDR');
          off += ihdrLen; // IHDR data
          off += 4; // IHDR CRC

          const head = bytes.subarray(0, off);
          const tail = bytes.subarray(off);

          const textChunk = makeTextChunk(keyword, text);
          const out = concat(head, textChunk, tail);
          resolve(out);
        }catch(e){ reject(e); }
      };
      r.onerror = () => reject(new Error('PNG read failed'));
      r.readAsArrayBuffer(pngBlob);
    });

    function readU32(buf, idx){ return ((buf[idx]<<24) | (buf[idx+1]<<16) | (buf[idx+2]<<8) | (buf[idx+3])) >>> 0; }
    function str(u8){ return String.fromCharCode.apply(null, u8); }
  }

  // Reset form
  $('btnReset').addEventListener('click', () => {
    if (!confirm('Clear all fields?')) return;
    document.querySelectorAll('input[type="text"], textarea').forEach(el => el.value = '');
    $('character_version').value = '1.0';
    $('importFile').value = '';
    $('imageFile').value = '';
    $('imgPreview').src = ''; $('imgPreview').style.display='none';
    note(status, 'Cleared.');
    note(hdrStatus, '');
  });

  // Helpful defaults
  $('tags').value = 'generator\nstorycraft\nsci-fi';
})();
</script>
</body>
</html>
